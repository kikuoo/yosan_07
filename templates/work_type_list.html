{% extends "base.html" %}

{% block content %}
<h2>工種一覧 - {{ project.project_name }}</h2>

<div class="table-responsive mb-4">
    <table class="table table-striped">
        <thead>
            <tr>
                <th>工種コード</th>
                <th>工種名</th>
                <th>予算額</th>
                <th>支払済額</th>
                <th>残額</th>
                <th>操作</th>
            </tr>
        </thead>
        <tbody>
            {% for work_type in work_types %}
            <tr>
                <td>{{ work_type.work_code }}</td>
                <td>{{ work_type.work_name }}</td>
                <td>{{ work_type.budget_amount|format_currency }}</td>
                <td>{{ (work_type.budget_amount - work_type.remaining_amount)|format_currency }}</td>
                <td>{{ work_type.remaining_amount|format_currency }}</td>
                <td>
                    <div class="btn-group">
                        <a href="{{ url_for('payment', work_type_id=work_type.id) }}" class="btn btn-primary btn-sm">支払登録</a>
                        <a href="{{ url_for('edit_work_type', id=work_type.id) }}" class="btn btn-secondary btn-sm">編集</a>
                    </div>
                </td>
            </tr>
            <!-- 支払いリスト -->
            <tr>
                <td colspan="6">
                    <div class="ms-4">
                        <!-- 請負支払い -->
                        {% set contract_payments = work_type.payments|selectattr('payment_type', 'equalto', '請負')|list %}
                        {% if contract_payments %}
                        <h6 class="mt-2">請負支払い</h6>
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>支払日</th>
                                    <th>業者名</th>
                                    <th>金額</th>
                                    <th>備考</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for contract in contract_payments %}
                                <tr>
                                    <td>{% if contract.year %}{{ contract.year }}年{{ contract.month }}月{% else %}未定{% endif %}</td>
                                    <td>{{ contract.contractor }}</td>
                                    <td>{{ contract.amount|format_currency }}</td>
                                    <td>{{ contract.description }}</td>
                                    <td>
                                        <div class="btn-group">
                                            <a href="{{ url_for('edit_payment', payment_id=contract.id) }}" class="btn btn-outline-secondary btn-sm">編集</a>
                                            <a href="{{ url_for('progress_payment', work_type_id=work_type.id, contract_id=contract.id) }}" class="btn btn-outline-info btn-sm">出来高払い</a>
                                        </div>
                                    </td>
                                </tr>
                                <!-- この請負契約に関連する出来高払いリスト -->
                                {% set progress_payments = work_type.payments|selectattr('payment_type', 'equalto', '出来高')|selectattr('contractor', 'equalto', contract.contractor)|selectattr('work_type_id', 'equalto', work_type.id)|selectattr('contract_id', 'equalto', contract.id)|list %}
                                {% if progress_payments %}
                                <tr>
                                    <td colspan="5" class="border-0">
                                        <div class="ms-4 mb-3">
                                            <h6 class="text-muted mb-2">{{ contract.contractor }}の出来高払い履歴</h6>
                                            <table class="table table-sm table-bordered">
                                                <thead class="table-light">
                                                    <tr>
                                                        <th>支払日</th>
                                                        <th>金額</th>
                                                        <th>出来高率</th>
                                                        <th>累計出来高率</th>
                                                        <th>備考</th>
                                                        <th>操作</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {% for progress in progress_payments|sort(attribute='year,month') %}
                                                    <tr>
                                                        <td>{{ progress.year }}年{{ progress.month }}月</td>
                                                        <td>{{ progress.amount|format_currency }}</td>
                                                        <td>{{ progress.progress_rate }}%</td>
                                                        <td>{{ progress.current_progress }}%</td>
                                                        <td>{{ progress.description }}</td>
                                                        <td>
                                                            <a href="{{ url_for('edit_payment', payment_id=progress.id) }}" class="btn btn-outline-secondary btn-sm">編集</a>
                                                        </td>
                                                    </tr>
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                                        </div>
                                    </td>
                                </tr>
                                {% endif %}
                                {% endfor %}
                            </tbody>
                        </table>
                        {% endif %}

                        <!-- 請負外支払い -->
                        {% set non_contract_payments = work_type.payments|selectattr('payment_type', 'equalto', '請負外')|list %}
                        {% if non_contract_payments %}
                        <h6 class="mt-3">請負外支払い</h6>
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>支払日</th>
                                    <th>業者名</th>
                                    <th>金額</th>
                                    <th>備考</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for payment in non_contract_payments %}
                                <tr>
                                    <td>{% if payment.year %}{{ payment.year }}年{{ payment.month }}月{% else %}未定{% endif %}</td>
                                    <td>{{ payment.contractor }}</td>
                                    <td>{{ payment.amount|format_currency }}</td>
                                    <td>{{ payment.description }}</td>
                                    <td>
                                        <a href="{{ url_for('edit_payment', payment_id=payment.id) }}" class="btn btn-outline-secondary btn-sm">編集</a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                        {% endif %}

                        {% if not contract_payments and not non_contract_payments %}
                        <p class="text-muted mt-2">支払い情報はありません</p>
                        {% endif %}
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<a href="{{ url_for('add_work_type', project_id=project.id) }}" class="btn btn-primary">工種追加</a>
<a href="{{ url_for('index') }}" class="btn btn-secondary">戻る</a>

{% endblock %} 